+++
date = "2018-10-07"
description = "Analysis breakdown of the Facebooks prophet model. In this post we implement prophet in Pymc3."
tags = ["machine learning", "python", "algorithm breakdown", "time series", "pymc3"]
draft = true
keywords =["machine learning", "python", "numpy", "arima", "time series", "prophet", "facebook"]
author = "Ritchie Vink"
title = "Rebuild Facebook's prophet in Pymc3; Bayesian time series analyis with generalized additive models"
og_image = "/img/post-19-prophet/head.png"
+++

{{< figure src="/img/post-19-prophet/head.png" >}}

<br>
Last [Algorithm Breakdown]({{< ref "post/arima.md" >}}) we build an ARIMA model from scratch and discussed the use cases of that kind of models. ARIMA models are great when you have got stationary data and when you want to predict a few time steps in to the future. A lot of business data, being generated by human processes, have got weekly and yearly seasonalities (we seem work to less in weekends and holidays) and show peaks at certain events. This kind of data is
measured a lot and there is time series expertise needed to model this correctly. Facebook has released an open source tool, Prophet, for analyzing this type of business data. Prophet is able to fit a robust model and makes advanced time series analysis more available for laymen. 

This post we break down the components of Prophet and implement it in Pymc3.

## Generalized Additive Models
Prophet is based on Generalized Additive Models, which is actually nothing more than a fancy name for the summation of the outputs of different models. In Prophets case, it is the summation of a trend $g(t)$, a seasonal series $s(t)$, and a holiday effect (special events) $h(t)$. 

$$ y(t) = g(t) + s(t) + h(t) + \epsilon\_t \tag{1}$$

$y(t)$ is the time series data we observe at time $t$, and $\epsilon$ is some stochastic process we cannot explain. 

With a probablistic framework such as [Stan](http://mc-stan.org/) or [Pymc3](https://docs.pymc.io/), we can define priors on the parameters of terms $g(t)$, $s(t)$, and $h(t)$ and then sample the posterior distribution to find the maximum likelihood of $y(t)$ (observed data). Facebook has implemented this model in probablistic framework Stan. We are going to implement it in Pymc3. In this post we will only focus on the terms $g(t)$ and $s(t)$ as that covers the gist of the problem. Implementing $h(t)$ is an easy extension which I leave for the enthusiastic readers.

## Linear Trend with Changepoints
We will model a piece-wise constant growth described by

$$ g(t) = (k + a(t)^T \delta)t + (m + a(t)^T \gamma) \tag{2}$$ 

where $k$ is the growth rate, $m$ is the offset parameter, $\delta$ is a vector with growth rate adjustments, and $\gamma\_j$ is set to $-s\_j \delta\_j$, where $s\_j$ is a changepoint in time.

This growth model consists of a base trend $k$ and preset changepoints at which the growth rate can be adjusted by $s\_j$. Those preset changepoints are defined in a vector $S$ with changepoints at times $s\_j$, $j = 1, ..., S$. At each unique changepoint $s\_j$, the growth rate is adjusted by $\delta\_j$. We can define all growth rate adjustments by the vector $\delta \in \mathbb{R}^S$

The growth rate is adjusted every time step that $t$ surpasses a changepoints $s\_j$, the growth rate becomes the base rate plus the sum off all adjustments up to that point

$$ k + \sum\_{j: t > s\_j} \delta\_j \tag{3}$$

**Eq (3)** can be vectorized by defining $a(t) \in {0, 1}^S$ such that

<div>$$ 

 a(t)=

\begin{cases}
    1,              & \text{if } t\geq s\_j, \\
    0,              & \text{otherwise}
\end{cases}

\tag{4}
$$</div> 

By taking the dot product, all the changepoints $s\_j > t$ cancel out. The growth rate at time $t$ is then

$$ k + a(t)^T \delta \tag{5} $$

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
  });
  </script>

<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

<head>

<style>

.formula-wrap {
overflow-x: scroll;
}

</style>

</head>
